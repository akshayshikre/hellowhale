pipeline {
  agent any
  stages {
    stage('Cloning') {
      steps {
        checkout scm
      }
    }
    stage('Building') {
      steps{
        script {
          dockerImage = docker.build "akshayshikre/hellowhale:${env.BUILD_ID}"
        }
      }
    }
    stage('Pushing') {
      steps{
        script {
          docker.withRegistry( '', 'dockerhubcredentials' ) {
            dockerImage.push()
          }
        }
      }
    }
    stage('Kubectl') {
            steps {
              docker.withRegistry('') {
               docker.image("lachlanevenson/k8s-kubectl:v1.10.10").inside {
                  withKubeConfig([credentialsId: 'kubedefaultsystem',
                     caCertificate: '',
                     serverUrl: 'https://157.230.9.247:6443',
                     contextName: 'kubernetes-admin@kubernetes',
                     clusterName: 'kubernetes'
                     ]) {
                        //sh 'hostname'
                        //sh 'kubectl config view'
                        //sh 'kubectl version'
                        //sh 'kubectl get pods -n default'
                        sh 'kubectl set image deployment/hellowhale -n default hellowhale=akshayshikre/hellowhale:${env.BUILD_ID}'
                        //sh 'sleep 30'
                        sh 'kubectl rollout history -n default deployment/hellowhale'
                       }
                }
              }
            }
        }
    
    
  }
}
